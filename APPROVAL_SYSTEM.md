# 承認システム詳細仕様書

## 📋 概要

わかくさシフト管理システムでは、スタッフ登録とシフト登録に承認フローを導入しています。
これにより、管理者が適切にスタッフとシフトの管理を行うことができます。

## 🔄 承認フロー詳細

### 1. スタッフ登録承認フロー

#### 1.1 登録プロセス
1. **スタッフが新規登録**
   - スタッフ登録画面で基本情報を入力
   - ユーザーアカウント作成オプション選択可能
   - 登録ボタンクリック

2. **システム処理**
   - `approval_status = 'pending'` で保存
   - 「管理者の承認をお待ちください」メッセージ表示
   - スタッフ一覧に「承認待ち」バッジで表示

3. **管理者による承認**
   - Admin画面でスタッフ一覧確認
   - 承認待ちスタッフが優先表示
   - 一括承認または個別承認

#### 1.2 承認後の動作
- **承認済み**: シフト登録フォームに表示される
- **却下**: シフト登録フォームに表示されない

### 2. シフト登録承認フロー

#### 2.1 スタッフによるシフト登録
1. **シフト登録**
   - スタッフ画面でシフト登録
   - 自分のシフトのみ登録可能
   - 登録時に `approval_status = 'pending'` で保存

2. **システム処理**
   - `created_by` に登録者を記録
   - 「管理者の承認をお待ちください」メッセージ表示
   - カレンダーには表示されない（承認済みのみ表示）

#### 2.2 管理者によるシフト登録
1. **シフト登録**
   - 管理画面でシフト登録
   - 全スタッフのシフト登録可能
   - 登録時に `approval_status = 'approved'` で保存

2. **システム処理**
   - `approved_at` に現在時刻を設定
   - `approved_by` に管理者を記録
   - 即座にカレンダーに表示

## 🎯 承認状態の管理

### 承認状態の種類

| 状態 | 値 | 説明 | 表示 |
|------|-----|------|------|
| 承認待ち | `pending` | 登録後、承認待ちの状態 | 🕐 承認待ち |
| 承認済み | `approved` | 管理者が承認した状態 | ✅ 承認済み |
| 却下 | `rejected` | 管理者が却下した状態 | ❌ 却下 |

### データベースフィールド

#### Staffテーブル
```sql
approval_status VARCHAR(20) DEFAULT 'pending'  -- 承認状態
approved_at DATETIME NULL                      -- 承認日時
approved_by_id INTEGER NULL                    -- 承認者ID
rejection_reason TEXT NULL                     -- 却下理由
```

#### Shiftテーブル
```sql
approval_status VARCHAR(20) DEFAULT 'approved' -- 承認状態（管理者作成はデフォルト承認済み）
approved_at DATETIME NULL                      -- 承認日時
approved_by_id INTEGER NULL                    -- 承認者ID
rejection_reason TEXT NULL                     -- 却下理由
created_by_id INTEGER NULL                     -- 作成者ID
```

## 🖥️ Admin画面での操作

### スタッフ承認画面

#### 表示項目
- 名前、メール、電話番号、役職
- 承認状態（バッジ表示）
- 作成日時、承認日時
- 承認者

#### 操作機能
1. **一括承認**
   - 複数のスタッフを選択して一括承認
   - 承認日時と承認者を自動設定

2. **一括却下**
   - 複数のスタッフを選択して一括却下
   - 却下理由の入力（オプション）

3. **個別編集**
   - 個別のスタッフ詳細画面で承認状態変更
   - 却下理由の詳細入力

### シフト承認画面

#### 表示項目
- スタッフ名、日付、シフト種別
- 開始時間、終了時間
- 承認状態（バッジ表示）
- 作成者、承認者

#### フィルター機能
- 承認状態でフィルター
- 作成者でフィルター
- 日付範囲でフィルター

#### 操作機能
1. **一括承認**
   - 複数のシフトを選択して一括承認
   - 承認日時と承認者を自動設定

2. **一括却下**
   - 複数のシフトを選択して一括却下
   - 却下理由の入力（オプション）

## 🔍 表示制御

### カレンダー表示
- **承認済みシフトのみ表示**
- 承認待ち・却下されたシフトは非表示
- 事由付きシフト（公休・有給等）は承認不要で表示

### スタッフ選択肢
- **承認済みスタッフのみ表示**
- シフト登録フォームで選択可能
- 承認待ち・却下されたスタッフは選択不可

### 一覧画面
- **全ての状態を表示**
- 承認状態をバッジで視覚的に表示
- 承認待ちを優先表示

## 🚨 エラーハンドリング

### 承認エラー
1. **既に承認済みの場合**
   - 警告メッセージ表示
   - 操作をスキップ

2. **権限不足の場合**
   - エラーメッセージ表示
   - 操作を拒否

3. **データ不整合の場合**
   - ログに記録
   - 管理者に通知

## 📊 統計・レポート

### 承認状況の統計
- 承認待ちスタッフ数
- 承認待ちシフト数
- 月別承認件数
- 承認者別統計

### 通知機能（将来拡張）
- 承認待ち件数の通知
- メール通知
- ダッシュボード表示

## 🔧 設定・カスタマイズ

### 承認設定
```python
# settings.py
APPROVAL_SETTINGS = {
    'STAFF_AUTO_APPROVE': False,      # スタッフ自動承認
    'SHIFT_AUTO_APPROVE': False,      # シフト自動承認
    'ADMIN_AUTO_APPROVE': True,       # 管理者作成は自動承認
    'NOTIFICATION_ENABLED': False,    # 通知機能
}
```

### 権限設定
- **管理者**: 全ての承認操作可能
- **スタッフ**: 自分のシフトのみ登録可能
- **ゲスト**: 閲覧のみ

## 🔄 ワークフロー例

### 新人スタッフ登録の例
1. **新人が自己登録**
   ```
   名前: 田中 花子
   メール: tanaka@example.com
   電話: 090-1234-5678
   役職: アルバイト
   ```

2. **システム処理**
   ```
   approval_status: 'pending'
   created_at: 2025-06-13 10:00:00
   ```

3. **管理者が確認・承認**
   ```
   approval_status: 'approved'
   approved_at: 2025-06-13 14:30:00
   approved_by: 管理者
   ```

4. **承認後**
   - シフト登録フォームに表示
   - カレンダーでシフト登録可能

### シフト登録・承認の例
1. **スタッフがシフト登録**
   ```
   スタッフ: 田中 花子
   日付: 2025-06-15
   シフト種別: 早番
   時間: 09:00-17:00
   ```

2. **システム処理**
   ```
   approval_status: 'pending'
   created_by: 田中 花子
   created_at: 2025-06-13 15:00:00
   ```

3. **管理者が承認**
   ```
   approval_status: 'approved'
   approved_at: 2025-06-13 16:00:00
   approved_by: 管理者
   ```

4. **承認後**
   - カレンダーに表示
   - PDF/CSV出力に含まれる

## 📝 注意事項

### 運用上の注意
1. **承認の迅速性**
   - 承認待ちが長期間放置されないよう注意
   - 定期的な承認作業の実施

2. **却下理由の明確化**
   - 却下時は理由を明記
   - スタッフへのフィードバック

3. **データの整合性**
   - 承認済みデータの変更時は再承認検討
   - バックアップの定期取得

### セキュリティ考慮事項
1. **権限管理**
   - 管理者権限の適切な付与
   - 定期的な権限見直し

2. **ログ管理**
   - 承認操作のログ記録
   - 不正操作の検知

---

**最終更新**: 2025年6月13日  
**バージョン**: 1.0.0 