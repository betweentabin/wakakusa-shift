{% extends "base.html" %}
{% load static %}

{% block title %}シフトカレンダー{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<link rel="stylesheet" href="{% static 'css/calendar_mobile.css' %}">
<style>
  .calendar-container {
    margin-bottom: 15px;
  }
  
  @media (max-width: 768px) {
    .calendar-container {
      margin-bottom: 10px;
    }
  }
  .fc-event {
    cursor: pointer;
  }
  .shift-legend {
    display: flex;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  .shift-type-item {
    display: flex;
    align-items: center;
    margin-right: 15px;
    margin-bottom: 5px;
  }
  .shift-type-color {
    width: 20px;
    height: 20px;
    margin-right: 5px;
    border-radius: 3px;
  }
  .fc-event-time, .fc-event-title {
    padding: 0 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .fc-day-today {
    background-color: rgba(255, 220, 40, 0.15) !important;
  }
  .fc-day-sat {
    background-color: rgba(0, 120, 255, 0.05);
  }
  .fc-day-sun {
    background-color: rgba(255, 80, 80, 0.05);
  }
  .extended-action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .mobile-quick-actions {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }
  
  .quick-action-fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background-color: #007bff;
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-bottom: 12px;
    transition: all 0.3s ease;
  }
  
  .quick-action-fab:hover {
    background-color: #0056b3;
    transform: scale(1.1);
  }
  
  .compact-filter {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .filter-toggle {
    cursor: pointer;
    user-select: none;
  }
  
  .filter-content {
    margin-top: 15px;
  }
  
  @media (max-width: 768px) {
    .extended-action-buttons {
      flex-direction: column;
    }
    .extended-action-buttons .btn {
      margin-bottom: 5px;
    }
    .staff-filter .form-check-inline {
      display: block;
      margin-right: 0;
      margin-bottom: 0.5rem;
    }
    
    .mobile-quick-actions {
      display: block;
    }
    
    .desktop-action-buttons {
      display: none;
    }
    
    .calendar-header-mobile {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(108, 117, 125, 0.15);
    }
    
    .calendar-header-mobile h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    
    .calendar-header-mobile .subtitle {
      font-size: 0.8rem;
      opacity: 0.85;
      margin-top: 2px;
    }
    
    .compact-filter {
      padding: 12px;
    }
    
    .filter-content {
      margin-top: 12px;
    }
  }

  /* モバイル向けカレンダー調整 */
  @media (max-width: 767.98px) {
    .fc-header-toolbar {
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 10px 8px;
      background-color: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .fc-header-toolbar .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .fc-header-toolbar .fc-toolbar-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin: 0;
      text-align: center;
      color: #333;
      order: 1;
    }

    /* 前/次/今日ボタンを横並びに */
    .fc-header-toolbar .fc-toolbar-chunk:first-child {
      order: 2;
      margin-top: 6px;
    }

    .fc-header-toolbar .fc-toolbar-chunk:first-child .fc-button-group {
      display: flex;
      gap: 6px;
    }

    /* 表示切り替えボタンを横並びに */
    .fc-header-toolbar .fc-toolbar-chunk:last-child {
      order: 3;
      margin-top: 6px;
    }

    .fc-header-toolbar .fc-toolbar-chunk:last-child .fc-button-group {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 2px;
    }

    .fc-header-toolbar .fc-toolbar-chunk:last-child .fc-button {
      flex: 0 0 auto;
      min-width: 30px;
      font-size: 0.65rem;
      padding: 3px 4px;
    }

    .fc-button {
      font-size: 0.9rem;
      padding: 8px 12px;
      border-radius: 6px;
      min-height: 40px;
      font-weight: 500;
      border: 1px solid #dee2e6;
      background-color: white;
      color: #495057;
    }

    /* FullCalendarのボタングループを強制的に横並びに */
    .fc .fc-button-group {
      display: flex !important;
      flex-direction: row !important;
    }

    .fc .fc-button-group .fc-button {
      margin: 0 2px !important;
    }

    .fc-button:hover {
      background-color: #e9ecef;
    }

    .fc-button-active {
      background-color: #007bff !important;
      border-color: #007bff !important;
      color: white !important;
    }

    /* 今日ボタンを目立たせる */
    .fc-today-button {
      background-color: #28a745 !important;
      border-color: #28a745 !important;
      color: white !important;
    }

    .fc-today-button:hover {
      background-color: #218838 !important;
      border-color: #1e7e34 !important;
    }

    /* 前/次ボタンのスタイル */
    .fc-prev-button, .fc-next-button {
      background-color: #6c757d !important;
      border-color: #6c757d !important;
      color: white !important;
    }

    .fc-prev-button:hover, .fc-next-button:hover {
      background-color: #5a6268 !important;
      border-color: #545b62 !important;
    }

    .fc-daygrid-day-bottom .fc-daygrid-more-link {
      font-size: 0.75rem;
      padding: 2px 4px;
    }
  }

  /* 超小型画面向け調整 */
  @media (max-width: 480px) {
    .fc-header-toolbar .fc-toolbar-title {
      font-size: 1rem;
    }

    .fc-button {
      font-size: 0.75rem;
      padding: 6px 8px;
      min-height: 36px;
      min-width: 50px;
    }

    /* 表示切り替えボタンも横並びを維持 */
    .fc-header-toolbar .fc-toolbar-chunk:last-child .fc-button-group {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 1px;
    }

    .fc-header-toolbar .fc-toolbar-chunk:last-child .fc-button {
      flex: 0 0 auto;
      font-size: 0.55rem;
      padding: 2px 3px;
      min-width: 26px;
    }
    
    /* カードのパディング調整 */
    .card-body {
      padding: 10px;
    }
    
    .card-header {
      padding: 8px 10px;
    }
    
    /* フォーム要素の調整 */
    .form-control {
      font-size: 14px;
      padding: 6px 8px;
    }
    
    .btn {
      font-size: 0.8rem;
      padding: 6px 10px;
    }
    
    /* シフト凡例の調整 */
    .shift-legend {
      margin-bottom: 15px;
    }
    
    .shift-type-item {
      margin-right: 10px;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }
    
    .shift-type-color {
      width: 16px;
      height: 16px;
    }
  }
  
  /* 極小画面（400px以下）向け調整 */
  @media (max-width: 400px) {
    .fc-header-toolbar .fc-toolbar-title {
      font-size: 0.9rem;
    }
    
    .fc-button {
      font-size: 0.55rem;
      padding: 2px 3px;
      min-height: 24px;
      min-width: 24px;
    }
    
    .card-body {
      padding: 8px;
    }
    
    .card-header {
      padding: 6px 8px;
    }
    
    .form-control {
      font-size: 13px;
      padding: 5px 6px;
    }
    
    .btn {
      font-size: 0.75rem;
      padding: 5px 8px;
    }
    
    .shift-type-item {
      font-size: 0.75rem;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    
    .shift-type-color {
      width: 14px;
      height: 14px;
    }
    
    .quick-action-fab {
      width: 48px;
      height: 48px;
      font-size: 1rem;
    }
  }

  /* メインコンテンツコンテナのflexbox制御 */
  .main-content-container {
    display: flex;
    flex-direction: column;
  }

  /* モバイル版でボタンとカレンダーの順序を逆にする */
  @media (max-width: 767.98px) {
    .main-content-container {
      display: flex;
      flex-direction: column;
    }

    /* 期間設定: order 1 */
    .main-content-container > .row:nth-child(1) {
      order: 1;
    }

    /* カレンダー: order 3 */
    .main-content-container > .row:nth-child(2) {
      order: 3;
    }

    /* フィルター: order 2 */
    .main-content-container > .row:nth-child(3) {
      order: 2;
    }

    /* アクションボタン: order 4 */
    .main-content-container > .row:nth-child(4) {
      order: 4;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- モバイル専用ヘッダー -->
  <div class="calendar-header-mobile d-md-none">
    <h3 style="font-size: 1.2rem; margin: 0;">シフト管理</h3>
    <div class="subtitle" style="font-size: 0.8rem;">スケジュール確認・編集</div>
  </div>
  
  <!-- デスクトップ用タイトル -->
  <h1 class="mb-4 d-none d-md-block">シフトカレンダー</h1>
  
  <!-- メインコンテンツコンテナ（モバイルでflexbox順序制御） -->
  <div class="main-content-container">
  
  <!-- シフト表示期間設定 -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <!-- デスクトップ用ヘッダー -->
        <div class="card-header d-none d-md-block">
          <h5 class="card-title mb-0">
            <i class="fas fa-calendar-alt me-2"></i>
            表示期間設定
          </h5>
        </div>
        <!-- モバイル用コンパクトヘッダー -->
        <div class="card-header d-md-none py-1">
          <h6 class="card-title mb-0" style="font-size: 0.85rem;">
            <i class="fas fa-calendar-alt me-1"></i>
            期間設定
          </h6>
        </div>
        <div class="card-body py-2">
          <!-- デスクトップ用レイアウト -->
          <form method="get" class="d-none d-md-block">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="id_start_date" class="form-label">開始日</label>
                {{ form.start_date }}
              </div>
              <div class="col-md-4">
                <label for="id_end_date" class="form-label">終了日</label>
                {{ form.end_date }}
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-search me-2"></i>
                  期間変更
                </button>
              </div>
            </div>
          </form>
          
          <!-- モバイル用コンパクトレイアウト -->
          <form method="get" class="d-md-none">
            <div class="row g-1">
              <div class="col-5">
                <label for="id_start_date_mobile" class="form-label small mb-1">開始</label>
                <input type="date" class="form-control form-control-sm" id="id_start_date_mobile" name="start_date" value="{{ form.start_date.value|default:'' }}" style="padding: 4px 8px;">
              </div>
              <div class="col-5">
                <label for="id_end_date_mobile" class="form-label small mb-1">終了</label>
                <input type="date" class="form-control form-control-sm" id="id_end_date_mobile" name="end_date" value="{{ form.end_date.value|default:'' }}" style="padding: 4px 8px;">
              </div>
              <div class="col-2 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary btn-sm w-100" style="padding: 4px 2px; font-size: 0.75rem;">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- メインカレンダー -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-calendar me-2"></i>
            シフトカレンダー
          </h5>
        </div>
        <div class="card-body py-2">
          <!-- モバイル用スクロールヒント -->
          <div class="d-md-none alert alert-info py-1 mb-2" style="font-size: 0.75rem;">
            <i class="fas fa-hand-point-right me-1"></i>
            横スワイプで全体表示
          </div>
          <div class="calendar-container">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- コンパクトなフィルターセクション -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="compact-filter">
        <div class="filter-toggle d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#filterContent">
          <h6 class="mb-0">
            <i class="fas fa-filter me-2"></i>
            表示フィルター
          </h6>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="collapse filter-content" id="filterContent">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">スタッフ</label>
              <div class="staff-filter">
                <!-- 全選択/全解除ボタン -->
                <div class="mb-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllStaff">全て選択</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllStaff">全て解除</button>
                </div>
                {% for staff in staff_list %}
                <div class="form-check form-check-inline">
                  <input class="form-check-input staff-checkbox" type="checkbox" id="staff-{{ staff.id }}" value="{{ staff.id }}" checked>
                  <label class="form-check-label" for="staff-{{ staff.id }}">{{ staff.name }}</label>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">シフト種別</label>
              <div class="shift-legend">
                {% for type in shift_types %}
                <div class="shift-type-item">
                  <div class="shift-type-color" style="background-color: {{ type.color }};"></div>
                  <span>{{ type.name }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- アクションボタンセクション -->
  <div class="row">
    <div class="col-12">
      <!-- デスクトップ用アクションボタン -->
      <div class="desktop-action-buttons d-none d-md-block">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-tools me-2"></i>
              操作メニュー
            </h5>
          </div>
          <div class="card-body">
            <div class="extended-action-buttons">
              <a href="{% url 'shift_management:shift_create' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> 新規シフト登録
              </a>
              <a href="{% url 'shift_management:bulk_shift_create' %}" class="btn btn-success">
                <i class="fas fa-calendar-plus"></i> 複数シフト一括登録
              </a>
              <a href="{% url 'shift_management:shift_reason_create' %}" class="btn btn-warning">
                <i class="fas fa-calendar-times"></i> 事由登録
              </a>
              <a href="{% url 'shift_management:template_list' %}" class="btn btn-info">
                <i class="fas fa-clipboard-list"></i> テンプレート管理
              </a>
              <a href="{% url 'shift_management:staff_list' %}" class="btn btn-secondary">
                <i class="fas fa-users"></i> スタッフ管理
              </a>
              <a href="{% url 'shift_management:shift_type_list' %}" class="btn btn-warning">
                <i class="fas fa-tags"></i> シフト種別管理
              </a>
              <a href="{% url 'shift_management:shift_export' %}" class="btn btn-primary">
                <i class="fas fa-file-export"></i> シフト表印刷・エクスポート
              </a>
              <a href="{% url 'shift_management:time_chart' %}" class="btn btn-info">
                <i class="fas fa-chart-bar"></i> 時間チャートを確認する
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- モバイル用簡易アクションボタン -->
      <div class="extended-action-buttons d-md-none">
        <div class="card">
          <div class="card-header">
            <h6 class="card-title mb-0">
              <i class="fas fa-tools me-2"></i>
              クイック操作
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-6">
                <a href="{% url 'shift_management:shift_create' %}" class="btn btn-success w-100">
                  <i class="fas fa-plus me-2"></i>
                  新規登録
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'shift_management:bulk_shift_create' %}" class="btn btn-info w-100">
                  <i class="fas fa-calendar-plus me-2"></i>
                  一括登録
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'shift_management:shift_reason_create' %}" class="btn btn-warning w-100">
                  <i class="fas fa-calendar-times me-2"></i>
                  事由登録
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'shift_management:staff_list' %}" class="btn btn-secondary w-100">
                  <i class="fas fa-users me-2"></i>
                  スタッフ
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'shift_management:shift_type_list' %}" class="btn btn-warning w-100">
                  <i class="fas fa-tags me-2"></i>
                  種別
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'shift_management:time_chart' %}" class="btn btn-info w-100">
                  <i class="fas fa-chart-bar me-2"></i>
                  時間チャート
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div> <!-- main-content-container 閉じタグ -->
  
  <!-- モバイル専用フローティングアクションボタン -->
  <div class="mobile-quick-actions d-md-none">
    <button class="quick-action-fab" onclick="location.href='{% url 'shift_management:time_chart' %}'">
      <i class="fas fa-chart-bar"></i>
    </button>
    <button class="quick-action-fab" onclick="location.href='{% url 'shift_management:shift_export' %}'">
      <i class="fas fa-file-export"></i>
    </button>
    <button class="quick-action-fab" onclick="location.href='{% url 'shift_management:template_list' %}'">
      <i class="fas fa-clipboard-list"></i>
    </button>
  </div>
  
  <!-- シフト詳細モーダル -->
  <div class="modal fade" id="shiftDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">シフト詳細</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="shiftDetailContent">
          <!-- シフト詳細がJSで挿入される -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <a href="#" class="btn btn-primary" id="editShiftBtn">編集</a>
          <button type="button" class="btn btn-danger" id="deleteShiftBtn" data-shift-id="">削除</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 日付クリック時の新規シフト登録モーダル -->
  <div class="modal fade" id="newShiftModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新規シフト登録</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>選択した日付: <span id="selectedDate"></span></p>
          <p>以下のオプションから選択してください:</p>
          <div class="d-grid gap-2">
            <a href="#" class="btn btn-primary" id="singleShiftBtn">
              <i class="fas fa-user"></i> 単一シフト登録
            </a>
            <a href="#" class="btn btn-success" id="bulkShiftBtn">
              <i class="fas fa-users"></i> 複数シフト一括登録
            </a>
            <a href="#" class="btn btn-info" id="templateBtn">
              <i class="fas fa-clipboard-list"></i> テンプレート適用
            </a>
            <a href="#" class="btn btn-warning" id="reasonBtn">
              <i class="fas fa-calendar-times"></i> 事由登録
            </a>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ja.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    let calendar;
    
    // カレンダーインスタンスを初期化
    function initCalendar() {
      let initialView = 'dayGridMonth';
      // モバイルでも月表示をデフォルトに（横スクロール対応のため）
      // if (window.innerWidth < 768) {
      //   initialView = 'listWeek';
      // }

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: initialView,
        locale: 'ja',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        buttonText: {
          today: '今日',
          month: '月',
          week: '週',
          day: '日',
          list: 'リスト'
        },
        // windowResize: function(arg) {
        //   if (window.innerWidth < 768) {
        //     if (calendar.view.type !== 'listWeek') {
        //       calendar.changeView('listWeek');
        //     }
        //   } else {
        //     if (calendar.view.type === 'listWeek') {
        //       calendar.changeView('dayGridMonth');
        //     }
        //   }
        // },
        events: function(info, successCallback, failureCallback) {
          // APIからシフトデータを取得
          fetch(`{% url 'shift_management:api_shifts' %}?start=${info.startStr}&end=${info.endStr}`)
            .then(response => response.json())
            .then(data => {
              successCallback(data);
            })
            .catch(error => {
              console.error('Error fetching shifts:', error);
              failureCallback(error);
            });
        },
        eventClick: function(info) {
          // シフト詳細モーダルを表示
          const shiftId = info.event.id;
          const staffId = info.event.extendedProps.staff_id;
          const shiftTypeId = info.event.extendedProps.shift_type_id;
          const title = info.event.title;
          const start = info.event.start;
          const end = info.event.end;
          const isReason = info.event.extendedProps.is_reason;
          
          // モーダル内容を設定
          const modalContent = document.getElementById('shiftDetailContent');
          
          if (isReason) {
            // 事由付きシフトの場合
            modalContent.innerHTML = `
              <p><strong>スタッフ:</strong> ${title.split(' (')[0]}</p>
              <p><strong>事由:</strong> ${title.split(' (')[1].replace(')', '')}</p>
              <p><strong>日付:</strong> ${start.toLocaleDateString()}</p>
              <p><strong>種別:</strong> <span class="badge bg-secondary">事由登録</span></p>
            `;
          } else {
            // 通常のシフトの場合
            modalContent.innerHTML = `
              <p><strong>スタッフ:</strong> ${title.split(' (')[0]}</p>
              <p><strong>シフト種別:</strong> ${title.split(' (')[1].replace(')', '')}</p>
              <p><strong>日付:</strong> ${start.toLocaleDateString()}</p>
              <p><strong>時間:</strong> ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} 〜 ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
            `;
          }
          
          // 編集・削除ボタンのリンクを設定
          document.getElementById('editShiftBtn').href = `/shift/${shiftId}/edit/`;
          document.getElementById('deleteShiftBtn').dataset.shiftId = shiftId;
          
          // モーダルを表示
          const modal = new bootstrap.Modal(document.getElementById('shiftDetailModal'));
          modal.show();
        },
        // 日付クリック時の処理（新規追加）
        dateClick: function(info) {
          // 選択した日付を表示
          document.getElementById('selectedDate').textContent = info.dateStr;
          
          // 各ボタンのリンクを設定
          const singleShiftBaseUrl = "{% url 'shift_management:shift_create' %}";
          document.getElementById('singleShiftBtn').href = `${singleShiftBaseUrl}?date=${info.dateStr}`;

          const bulkShiftBaseUrl = "{% url 'shift_management:bulk_shift_create' %}";
          document.getElementById('bulkShiftBtn').href = `${bulkShiftBaseUrl}?start_date=${info.dateStr}&end_date=${info.dateStr}`;
          
          document.getElementById('templateBtn').href = "{% url 'shift_management:template_list' %}"; 
          
          const reasonBaseUrl = "{% url 'shift_management:shift_reason_create' %}";
          document.getElementById('reasonBtn').href = `${reasonBaseUrl}?date=${info.dateStr}`;
          
          // モーダルを表示
          const modal = new bootstrap.Modal(document.getElementById('newShiftModal'));
          modal.show();
        },
        // その他のカレンダー設定
        dayMaxEvents: true,
        eventTimeFormat: {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        },
        // ドラッグ＆ドロップ機能（新規追加）
        editable: true,
        eventDrop: function(info) {
          // シフトの日時変更をサーバーに送信
          const shiftId = info.event.id;
          const newStart = info.event.start;
          const newEnd = info.event.end;
          
          // 確認ダイアログ
          if (confirm('シフトを移動しますか？')) {
            // AJAX送信用のデータ準備
            const formData = new FormData();
            formData.append('shift_id', shiftId);
            formData.append('new_date', newStart.toISOString().split('T')[0]);
            formData.append('new_start_time', newStart.toTimeString().slice(0, 5));
            formData.append('new_end_time', newEnd ? newEnd.toTimeString().slice(0, 5) : 
                                                    new Date(newStart.getTime() + 8 * 60 * 60 * 1000).toTimeString().slice(0, 5));
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // サーバーにPOSTリクエスト送信
            fetch('/shift-management/api/shift-update/', {
              method: 'POST',
              body: formData
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('シフトの更新に失敗しました');
              }
              return response.json();
            })
            .then(data => {
              // 成功メッセージ
              alert('シフトを更新しました');
            })
            .catch(error => {
              // エラー時は元の位置に戻す
              info.revert();
              console.error('Error updating shift:', error);
              alert('シフトの更新に失敗しました: ' + error.message);
            });
          } else {
            // キャンセル時は元の位置に戻す
            info.revert();
          }
        }
      });
      
      calendar.render();
    }
    
    // カレンダーを初期化
    initCalendar();
    
    // URLパラメータをチェックして自動更新
    function checkForAutoRefresh() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('refresh_calendar') && urlParams.get('refresh_calendar') === 'true') {
        // カレンダーを更新
        if (calendar) {
          calendar.refetchEvents();
        }
        
        // URLからパラメータを削除（ブラウザの戻るボタンで戻ったときに再度更新されないように）
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // 更新完了メッセージを表示
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
          <strong>更新完了!</strong> カレンダーが最新の情報に更新されました。
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // アラートを表示 (h1タグの後に挿入)
        const mainHeading = document.querySelector('.container-fluid.py-4 > h1');
        if (mainHeading) {
          mainHeading.parentNode.insertBefore(alertDiv, mainHeading.nextSibling);
        } else {
          // h1が見つからない場合はコンテナの最初に追加
           const container = document.querySelector('.container-fluid.py-4');
           if (container) {
                container.insertBefore(alertDiv, container.firstChild);
           }
        }
        
        // 5秒後にアラートを自動的に閉じる
        setTimeout(() => {
          const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
          if (bsAlert) {
            bsAlert.close();
          }
        }, 5000);
      }
    }
    
    // 自動更新チェック
    checkForAutoRefresh();
    
    // スタッフフィルター機能
    document.querySelectorAll('.staff-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const staffId = this.value;
        const isChecked = this.checked;
        
        if (calendar) {
            calendar.getEvents().forEach(event => {
              if (event.extendedProps.staff_id == staffId) {
                if (isChecked) {
                  event.setProp('display', 'auto');
                } else {
                  event.setProp('display', 'none');
                }
              }
            });
        }
      });
    });
    
    // 全選択/全解除ボタンの機能（新規追加）
    document.getElementById('selectAllStaff').addEventListener('click', function() {
      document.querySelectorAll('.staff-checkbox').forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
        }
      });
    });
    
    document.getElementById('deselectAllStaff').addEventListener('click', function() {
      document.querySelectorAll('.staff-checkbox').forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        }
      });
    });

    // Ajaxによるシフト削除処理
    const deleteShiftButton = document.getElementById('deleteShiftBtn');
    if (deleteShiftButton) {
      deleteShiftButton.addEventListener('click', function() {
        const shiftId = this.dataset.shiftId;
        if (!shiftId) {
          alert('削除対象のシフトIDが取得できませんでした。');
          return;
        }

        if (!confirm('本当にこのシフトを削除しますか？')) {
          return;
        }

        const formData = new FormData();
        formData.append('shift_id', shiftId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/api/shift-delete/`, { 
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || '削除に失敗しました。'); });
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('shiftDetailModal'));
            if (modalInstance) {
              modalInstance.hide();
            }
            if (calendar) {
              calendar.refetchEvents();
            }
          } else {
            alert(data.error || '削除に失敗しました。');
          }
        })
        .catch(error => {
          console.error('Error deleting shift:', error);
          alert('エラーが発生しました: ' + error.message);
        });
      });
    }

    // 表示期間変更フォームの処理
    const dateRangeForm = document.querySelector('.card-body form'); 
    if (dateRangeForm) {
      dateRangeForm.addEventListener('submit', function(event) {
        event.preventDefault(); 

        const startDateInput = document.getElementById('id_start_date'); 
        const endDateInput = document.getElementById('id_end_date');     

        if (!startDateInput || !endDateInput) {
          console.error('日付入力フィールドが見つかりません。');
          return;
        }

        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        if (startDate && calendar) {
          const currentUrl = new URL(window.location.href);
          currentUrl.searchParams.set('start_date', startDate);
          if (endDate) {
            currentUrl.searchParams.set('end_date', endDate);
          } else {
            currentUrl.searchParams.delete('end_date');
          }
          window.history.pushState({path: currentUrl.href}, '', currentUrl.href);

          calendar.gotoDate(startDate);
          calendar.refetchEvents();
        }
      });
    }
  });
</script>
{% endblock %} 